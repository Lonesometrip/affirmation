<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Baraka - Muslimisches Produktivitäts-System (Erweitert)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Baraka - Ein umfassendes muslimisches Produktivitätssystem mit dynamischer Tagesplanung, Gebetszeiten, Deep Work und spiritueller Balance">
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts: Inter -->
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/inter@3.3.1/400.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- FullCalendar CSS and JS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/de.js'></script>
    <style>
        html { 
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        ::selection { 
            background: #facc15;
            color: #000;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .task-item {
            transition: all 0.3s ease;
        }
        .task-item:hover {
            background-color: rgba(254, 243, 199, 0.5);
        }
        .task-item button {
            opacity: 0.7;
            transform: scale(0.95);
            transition: all 0.2s ease;
        }
        .task-item:hover button {
            opacity: 1;
            transform: scale(1);
        }
        @keyframes slideOut {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(-100%);
                opacity: 0;
            }
        }
        .slide-out {
            animation: slideOut 0.3s ease-out forwards;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-10%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .prayer-time-card {
            transition: all 0.3s ease;
        }
        .prayer-time-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .nav-link {
            position: relative;
            overflow: hidden;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #f59e0b;
            transition: width 0.3s ease;
        }
        .nav-link:hover::after {
            width: 100%;
        }
        /* FullCalendar customization */
        .fc {
            font-family: 'Inter', sans-serif;
        }
        .fc .fc-button-primary {
            background-color: #eab308;
            border-color: #eab308;
        }
        .fc .fc-button-primary:hover {
            background-color: #ca8a04;
            border-color: #ca8a04;
        }
        .fc .fc-button-primary:not(:disabled).fc-button-active,
        .fc .fc-button-primary:not(:disabled):active {
            background-color: #a16207;
            border-color: #a16207;
        }
        .fc-daygrid-day:hover {
            background-color: #fef3c7;
        }
        .fc-event {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .fc-event:hover {
            transform: scale(1.02);
        }
        /* Event type colors */
        .fc-event.bg-blue-500 {
            background-color: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }
        .fc-event.bg-purple-500 {
            background-color: #8b5cf6 !important;
            border-color: #8b5cf6 !important;
        }
        .fc-event.bg-green-500 {
            background-color: #22c55e !important;
            border-color: #22c55e !important;
        }
        .fc-event.bg-yellow-500 {
            background-color: #eab308 !important;
            border-color: #eab308 !important;
        }
        .event-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .event-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .event-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .event-form input,
        .event-form textarea,
        .event-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .event-form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        .event-form-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-event {
            background-color: #4CAF50;
            color: white;
        }
        .delete-event {
            background-color: #f44336;
            color: white;
        }
        .cancel-event {
            background-color: #9e9e9e;
            color: white;
        }
        #calendar {
            margin: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .opacity-50 {
            opacity: 0.5;
            pointer-events: none;
        }
        /* Quran Reader Styles */
        .ayah-container {
            margin-bottom: 12px;
            position: relative;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background-color: rgba(254, 243, 199, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ayah-container:hover {
            background-color: rgba(254, 243, 199, 0.2);
        }

        .arabic-text {
            font-family: 'Scheherazade New', 'Traditional Arabic', serif;
            font-size: 28px; /* Maintain original size for readability */
            text-align: right;
            line-height: 1.7;
            direction: rtl;
            color: #1f2937;
            padding-left: 24px;
            margin: 0; /* Remove margins */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        .translation-text {
            font-size: 14px;
            color: #4b5563;
            padding: 8px 10px;
            background-color: rgba(234, 179, 8, 0.05);
            border-radius: 6px;
            border-left: 2px solid #eab308;
            line-height: 1.4;
            margin: 0; /* Remove margins */
        }

        .ayah-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            background-color: #eab308;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 0 6px;
            order: 2; /* Move to end of flex container */
        }

        .bookmark-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 8px; /* Move to left side */
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            opacity: 0.5;
            transition: all 0.2s ease;
            color: #eab308;
            font-size: 16px;
            z-index: 2;
        }

        .bookmark-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .bookmark-btn.bookmarked {
            opacity: 1;
            color: #eab308;
        }

        .bookmark-item {
            padding: 6px !important;
            font-size: 13px !important;
            border-bottom: 1px solid rgba(234, 179, 8, 0.1);
        }

        .bookmark-item:hover {
            background-color: rgba(234, 179, 8, 0.05);
        }

        .bookmark-item:last-child {
            border-bottom: none;
        }

        .bookmark-item button {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .bookmark-item button:first-of-type {
            background-color: #eab308;
            color: white;
            margin-right: 8px;
        }

        .bookmark-item button:first-of-type:hover {
            background-color: #d97706;
        }

        .bookmark-item button:last-of-type {
            background-color: #ef4444;
            color: white;
        }

        .bookmark-item button:last-of-type:hover {
            background-color: #dc2626;
        }

        @media (max-width: 640px) {
            .control-panel {
                grid-template-columns: 1fr;
            }

            .ayah-container {
                padding: 6px 8px;
                margin-bottom: 8px;
            }

            .arabic-text {
                font-size: 24px;
                line-height: 1.6;
            }

            .translation-text {
                padding: 6px 8px;
                font-size: 13px;
                line-height: 1.3;
            }

            .bookmark-btn {
                padding: 3px;
                font-size: 14px;
            }

            .ayah-number {
                min-width: 20px;
                height: 20px;
                font-size: 11px;
            }

            /* Adjust section padding */
            #quran-reader .bg-white {
                padding: 8px !important;
            }
        }

        /* Compact layout for very small screens */
        @media (max-width: 360px) {
            .arabic-text {
                font-size: 22px;
                line-height: 1.5;
            }

            .translation-text {
                font-size: 12px;
                line-height: 1.2;
            }

            .ayah-container {
                padding: 4px 6px;
                margin-bottom: 6px;
            }
        }

        /* Add smooth scrolling for the container */
        #ayahs-container {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Add Scheherazade New font for Arabic text */
        @font-face {
            font-family: 'Scheherazade New';
            src: url('https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap');
        }

        .toggle-bookmarks {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #eab308;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 100;
            transition: all 0.2s ease;
        }

        .toggle-bookmarks:hover {
            transform: scale(1.1);
            background-color: #d97706;
        }

        .bookmark-item {
            padding: 12px;
            border-bottom: 1px solid rgba(234, 179, 8, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        /* Optimize control panel */
        .control-panel {
            padding: 8px !important;
            margin-bottom: 8px !important;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .control-panel select {
            padding: 6px !important;
            font-size: 14px !important;
            height: 32px;
        }

        .control-panel label {
            font-size: 12px !important;
            margin-bottom: 2px !important;
        }

        /* Optimize surah header */
        .surah-header {
            margin-bottom: 12px !important;
            padding-bottom: 8px !important;
            border-bottom: 1px solid rgba(234, 179, 8, 0.2);
        }

        .surah-name {
            font-size: 20px !important;
            margin-bottom: 2px !important;
        }

        .surah-translation {
            font-size: 14px !important;
            color: #666;
        }

        /* Optimize bookmarks panel */
        .bookmarks-panel {
            padding: 8px !important;
            margin-bottom: 8px !important;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Bottom Navigation Styles */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 8px 4px;
            display: block; /* Always show the navigation */
        }

        .bottom-nav-scroll {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            gap: 8px;
            padding: 0 8px;
        }

        .bottom-nav-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 72px;
            padding: 8px 12px;
            color: #4b5563;
            text-decoration: none;
            font-size: 12px;
            border-radius: 8px;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .bottom-nav-item.active {
            color: #eab308;
            background-color: #fef3c7;
        }

        .bottom-nav-item:hover {
            background-color: #fef3c7;
        }

        /* Adjust main content padding for bottom nav */
        body {
            padding-bottom: 80px !important; /* Space for bottom nav */
        }

        /* Adjust floating bookmark button position */
        .toggle-bookmarks {
            bottom: 90px !important; /* Move above bottom nav */
        }

        @media (min-width: 769px) {
            .bottom-nav {
                display: none; /* Hide on larger screens */
            }
            
            body {
                padding-bottom: 0 !important;
            }
            
            .toggle-bookmarks {
                bottom: 30px !important;
            }
        }

        /* Add these styles for the prayer widget */
        .prayer-widget {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 1rem;
            padding: 2rem;
            color: #2d3748;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .location-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            color: #4a5568;
        }

        .upcoming-prayer {
            text-align: center;
            margin-bottom: 2rem;
        }

        .upcoming-prayer h3 {
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        .prayer-time-large {
            font-size: 3rem;
            font-weight: 700;
            color: #2d3748;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .time-remaining {
            font-size: 0.9rem;
            color: #4a5568;
        }

        .sun-times {
            display: flex;
            justify-content: space-around;
            padding: 1rem 0;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .sun-time {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            color: #4a5568;
        }

        .prayer-list {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .prayer-list-header {
            background: #f7fafc;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
        }

        .prayer-list-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }

        .prayer-list-item:last-child {
            border-bottom: none;
        }

        .prayer-list-item:hover {
            background-color: #f7fafc;
        }

        .prayer-name {
            color: #4a5568;
            font-weight: 500;
        }

        .prayer-time {
            color: #2d3748;
            font-weight: 600;
        }

        .prayer-list-item.active {
            background-color: #fef3c7;
        }

        .prayer-list-item.passed {
            opacity: 0.6;
        }

        .prayer-list-item i {
            color: #d97706;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="bg-yellow-50 text-gray-800 min-h-screen w-full transition-colors duration-300 ease-in-out">
    <!-- Auth Modal -->
    <div id="authModal" class="modal transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-yellow-800" id="authModalTitle">Anmelden</h2>
                <button onclick="closeAuthModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="authForm" class="space-y-4">
                <div id="usernameField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Benutzername</label>
                    <input type="text" id="username" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">E-Mail</label>
                    <input type="email" id="email" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Passwort</label>
                    <input type="password" id="password" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                </div>
                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 px-4 rounded-lg transition-colors duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
                    <span id="authButtonText">Anmelden</span>
                </button>
            </form>
            <div class="mt-6 text-center">
                <button onclick="toggleAuthMode()" class="text-yellow-600 hover:text-yellow-800 text-sm transition-colors">
                    <span id="toggleAuthText">Kein Konto? Registrieren</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-yellow-100 to-yellow-200 py-8 shadow-lg mb-8 sticky top-0 z-10 transition-all duration-300">
        <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
            <div class="text-left">
                <h1 class="text-4xl font-bold tracking-tight mb-2 text-yellow-900 transform hover:scale-[1.02] transition-transform">
                    <i class="fas fa-moon-stars mr-2"></i>Baraka
                </h1>
                <p class="text-lg text-yellow-800 opacity-90">Das umfassende muslimische Produktivitätssystem</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="userInfo" class="hidden">
                    <span class="text-yellow-900 font-medium" id="userName"></span>
                    <button onclick="logout()" class="ml-4 text-yellow-700 hover:text-yellow-900 transition-colors">
                        <i class="fas fa-sign-out-alt"></i> Abmelden
                    </button>
                </div>
                <button id="loginButton" onclick="openAuthModal('login')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg">
                    <i class="fas fa-user mr-2"></i>Anmelden
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Wrapper -->
    <div class="max-w-4xl mx-auto px-4">
        <!-- Navigation -->
        <nav class="mb-8 flex flex-wrap gap-3 justify-center">
            <a href="#prayer-times" class="nav-link px-6 py-3 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-all duration-200 transform hover:scale-[1.05] active:scale-[0.98] shadow-sm hover:shadow-md">
                <i class="fas fa-mosque mr-2"></i>Gebetszeiten
            </a>
            <a href="#planner" class="nav-link px-6 py-3 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-all duration-200 transform hover:scale-[1.05] active:scale-[0.98] shadow-sm hover:shadow-md">
                <i class="fas fa-calendar-day mr-2"></i>Tagesplanung
            </a>
            <a href="#deep-work" class="nav-link px-6 py-3 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-all duration-200 transform hover:scale-[1.05] active:scale-[0.98] shadow-sm hover:shadow-md">
                <i class="fas fa-brain mr-2"></i>Deep Work
            </a>
            <a href="#spiritual" class="nav-link px-6 py-3 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-all duration-200 transform hover:scale-[1.05] active:scale-[0.98] shadow-sm hover:shadow-md">
                <i class="fas fa-heart mr-2"></i>Spiritualität
            </a>
            <a href="#calendar-view" class="nav-link px-6 py-3 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-all duration-200 transform hover:scale-[1.05] active:scale-[0.98] shadow-sm hover:shadow-md">
                <i class="fas fa-calendar-alt mr-2"></i>Kalender
            </a>
            <a href="#quran-reader" class="nav-link px-6 py-3 bg-yellow-100 hover:bg-yellow-200 rounded-lg transition-all duration-200 transform hover:scale-[1.05] active:scale-[0.98] shadow-sm hover:shadow-md">
                <i class="fas fa-book-quran mr-2"></i>Quran Reader
            </a>
        </nav>

        <!-- Gebetszeiten-Integration -->
        <section id="prayer-times" class="mb-12 fade-in">
            <div class="flex items-center mb-4">
                <i class="fas fa-mosque text-yellow-700 text-2xl mr-3"></i>
                <h2 class="text-2xl font-semibold text-yellow-800">Gebetszeiten-Integration</h2>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col md:flex-row gap-4 items-center md:items-stretch transform hover:scale-[1.01] transition-transform mb-6">
                <form class="flex flex-col sm:flex-row gap-3 flex-1" onsubmit="return setLocation(event)">
                    <label class="font-semibold flex items-center gap-2">
                        <i class="fas fa-location-dot text-yellow-600"></i>
                        Standort:
                        <input type="text" id="city" placeholder="Stadt oder PLZ" class="ml-2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required />
                    </label>
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-medium transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg">
                        <i class="fas fa-search-location mr-2"></i> Zeiten Laden
                    </button>
                </form>
                <button title="Standort automatisch erkennen" onclick="detectLocation()" class="self-start md:self-center px-4 py-2 text-yellow-700 hover:text-yellow-900 rounded-lg transition-all duration-200 hover:bg-yellow-100">
                    <i class="fas fa-crosshairs mr-1"></i> Automatisch
                </button>
            </div>
            
            <div class="prayer-widget">
                <div class="location-display">
                    <i class="fas fa-location-dot"></i>
                    <span id="current-location">Loading location...</span>
                </div>
                
                <div class="upcoming-prayer">
                    <h3>NÄCHSTES GEBET</h3>
                    <div class="prayer-time-large" id="next-prayer-time">--:--</div>
                    <div class="time-remaining" id="time-remaining">-- minutes to go</div>
                </div>
                
                <div class="sun-times">
                    <div class="sun-time">
                        <i class="fas fa-sun"></i>
                        <span id="sunrise-time">--:--</span>
                    </div>
                    <div class="sun-time">
                        <i class="fas fa-moon"></i>
                        <span id="sunset-time">--:--</span>
                    </div>
                </div>
            </div>

            <div class="prayer-list">
                <div class="prayer-list-header">
                    <i class="fas fa-calendar"></i>
                    <span id="current-date">Today / Loading...</span>
                </div>
                <div id="daily-prayers">
                    <div class="prayer-list-item">
                        <span class="prayer-name">Fajr</span>
                        <span class="prayer-time" id="fajr-time">--:--</span>
                    </div>
                    <div class="prayer-list-item">
                        <span class="prayer-name">Dhuhr</span>
                        <span class="prayer-time" id="dhuhr-time">--:--</span>
                    </div>
                    <div class="prayer-list-item">
                        <span class="prayer-name">Asr</span>
                        <span class="prayer-time" id="asr-time">--:--</span>
                    </div>
                    <div class="prayer-list-item">
                        <span class="prayer-name">Maghrib</span>
                        <span class="prayer-time" id="maghrib-time">--:--</span>
                    </div>
                    <div class="prayer-list-item">
                        <span class="prayer-name">Isha</span>
                        <span class="prayer-time" id="isha-time">--:--</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dynamische Tagesplanung -->
        <section id="planner" class="mb-12 fade-in">
            <div class="flex items-center mb-4">
                <i class="fas fa-calendar-day text-yellow-700 text-2xl mr-3"></i>
                <h2 class="text-2xl font-semibold text-yellow-800">Intelligente Tagesplanung</h2>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col gap-6 transform hover:scale-[1.01] transition-transform">
                <p class="text-gray-700 leading-relaxed">
                    Plane deinen Tag dynamisch in fünf Hauptabschnitten, getrennt durch die Gebetszeiten. Ziehe Aufgaben in die Zeitbereiche, strukturiere Deep Work und Freizeit, und sorge für spirituelle Balance.
                </p>
                <!-- Add day navigation -->
                <div class="flex items-center justify-between mb-4 bg-yellow-50 p-4 rounded-lg">
                    <button onclick="navigateDay(-1)" class="text-yellow-700 hover:text-yellow-900 transition-colors px-4 py-2 rounded-lg hover:bg-yellow-100">
                        <i class="fas fa-chevron-left"></i> Vorheriger Tag
                    </button>
                    <div class="text-center">
                        <h3 class="text-xl font-bold text-yellow-800" id="current-date-display"></h3>
                        <button onclick="goToToday()" class="mt-2 text-sm text-yellow-600 hover:text-yellow-800 transition-colors">
                            <i class="fas fa-calendar-day"></i> Heute
                        </button>
                    </div>
                    <button onclick="navigateDay(1)" class="text-yellow-700 hover:text-yellow-900 transition-colors px-4 py-2 rounded-lg hover:bg-yellow-100">
                        Nächster Tag <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="grid gap-4" id="planner-grid">
                    <!-- Die Zeitsegmente werden mit JS dynamisch eingefügt -->
                </div>
                <div class="flex flex-col md:flex-row gap-6">
                    <form class="flex-1 flex flex-col space-y-3" onsubmit="addTask(event)">
                        <div class="flex gap-3">
                            <input name="task" id="task-input" type="text" placeholder="Neue Aufgabe, z.B. Focusarbeit vorbereiten" 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                            <select id="segment-select" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200">
                                <option value="Fajr">Fajr</option>
                                <option value="Dhuhr">Dhuhr</option>
                                <option value="Asr">Asr</option>
                                <option value="Maghrib">Maghrib</option>
                                <option value="Isha">Isha</option>
                            </select>
                            <input type="date" id="task-date" 
                                class="w-40 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                            <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg" title="Aufgabe hinzufügen">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Deep Work Tracking -->
        <section id="deep-work" class="mb-12 fade-in">
            <div class="flex items-center mb-4">
                <i class="fas fa-brain text-yellow-700 text-2xl mr-3"></i>
                <h2 class="text-2xl font-semibold text-yellow-800">Deep Work-Tracking</h2>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col gap-6 transform hover:scale-[1.01] transition-transform">
                <form class="flex flex-col md:flex-row gap-3 items-baseline" onsubmit="addDeepWorkSession(event)">
                    <input id="deepwork-title" type="text" placeholder="Deep Work Thema (z.B. Budgetplanung)" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                    <select id="deepwork-segment" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200">
                        <option value="Fajr">Fajr</option>
                        <option value="Dhuhr">Dhuhr</option>
                        <option value="Asr">Asr</option>
                        <option value="Maghrib">Maghrib</option>
                        <option value="Isha">Isha</option>
                    </select>
                    <input id="deepwork-date" type="date" 
                        class="w-40 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                    <input id="deepwork-duration" type="number" min="15" max="360" step="15" placeholder="Dauer (Minuten)" 
                        class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg" title="Session speichern">
                        <i class="fas fa-save"></i>
                    </button>
                </form>
                <div class="relative h-64 rounded-lg overflow-hidden shadow-inner bg-gray-50">
                    <canvas id="deepwork-chart" class="absolute inset-0"></canvas>
                </div>
            </div>
        </section>

        <!-- Spirituelle Funktionen -->
        <section id="spiritual" class="mb-12 fade-in">
            <div class="flex items-center mb-4">
                <i class="fas fa-heart text-yellow-700 text-2xl mr-3"></i>
                <h2 class="text-2xl font-semibold text-yellow-800">Spirituelles Dashboard</h2>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 transform hover:scale-[1.01] transition-transform">
                <form class="flex flex-col sm:flex-row gap-3 items-baseline mb-6" onsubmit="addQuranGoal(event)">
                    <input id="quran-todo" type="text" placeholder="Quran-Leseziel (z.B. Surah Al-Kahf lesen)" required 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200">
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-md hover:shadow-lg">
                        <i class="fas fa-plus-circle mr-2"></i> Ziel
                    </button>
                </form>
                <ul id="quran-goals" class="list-disc ml-6 text-gray-700 space-y-3"></ul>
                <div class="mt-8 bg-yellow-50 rounded-lg p-4 border border-yellow-100">
                    <h3 class="font-bold text-yellow-700 mb-2"><i class="fas fa-lightbulb mr-2"></i> Tipp:</h3>
                    <p class="text-gray-700 leading-relaxed">
                        Halte einen täglichen Dhikr-Zähler, setze persönliche Du'a-Ziele oder baue islamische Routinen wie die <b>3-2-1-Regel</b> für deine Abendroutine ein (3h vorher nicht essen, 2h nicht trinken, 1h keine Bildschirme).
                    </p>
                </div>
            </div>
        </section>

        <!-- Calendar -->
        <section id="calendar-view" class="mb-12 fade-in">
            <div class="flex items-center mb-4">
                <i class="fas fa-calendar-alt text-yellow-700 text-2xl mr-3"></i>
                <h2 class="text-2xl font-semibold text-yellow-800">Kalenderübersicht</h2>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 transform hover:scale-[1.01] transition-transform">
                <!-- Calendar Filters -->
                <div class="mb-6 flex flex-wrap gap-3">
                    <button onclick="toggleEventType('all')" class="px-4 py-2 rounded-lg bg-yellow-500 text-white hover:bg-yellow-600 transition-colors">
                        <i class="fas fa-th-list mr-2"></i>Alle
                    </button>
                    <button onclick="toggleEventType('prayer')" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                        <i class="fas fa-mosque mr-2"></i>Gebete
                    </button>
                    <button onclick="toggleEventType('deep-work')" class="px-4 py-2 rounded-lg bg-green-500 text-white hover:bg-green-600 transition-colors">
                        <i class="fas fa-brain mr-2"></i>Deep Work
                    </button>
                    <button onclick="toggleEventType('task')" class="px-4 py-2 rounded-lg bg-yellow-400 text-white hover:bg-yellow-500 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Aufgaben
                    </button>
                    <button onclick="toggleEventType('quran')" class="px-4 py-2 rounded-lg bg-purple-500 text-white hover:bg-purple-600 transition-colors">
                        <i class="fas fa-book-open mr-2"></i>Quran
                    </button>
                </div>
                <!-- Calendar Container -->
                <div id="main-calendar" class="min-h-[600px]"></div>
            </div>
        </section>

        <!-- Quran Reader -->
        <section id="quran-reader" class="mb-12 fade-in">
            <div class="flex items-center mb-4">
                <i class="fas fa-book-quran text-yellow-700 text-2xl mr-3"></i>
                <h2 class="text-2xl font-semibold text-yellow-800">Quran Reader</h2>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 transform hover:scale-[1.01] transition-transform">
                <div class="app-header">
                    <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-yellow-500 to-yellow-600 bg-clip-text text-transparent">Quran</h1>
                    <p class="text-gray-600">Read with clarity and purpose</p>
                </div>

                <div class="bookmarks-panel bg-yellow-50 rounded-lg p-4 mb-6 hidden" id="bookmarks-panel">
                    <h3 class="flex justify-between items-center text-lg font-semibold text-yellow-800 mb-4">
                        <span>Your Bookmarks</span>
                        <button id="close-bookmarks" class="text-gray-500 hover:text-gray-700 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </h3>
                    <div id="bookmarks-list" class="max-h-96 overflow-y-auto"></div>
                </div>

                <div class="control-panel bg-yellow-50 rounded-lg p-4 mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="surah-select" class="block text-sm font-medium text-gray-700 mb-2">Surah</label>
                        <select id="surah-select" class="w-full px-4 py-2 border border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200">
                            <option value="">Loading surahs...</option>
                        </select>
                    </div>
                    <div>
                        <label for="translation-select" class="block text-sm font-medium text-gray-700 mb-2">Translation</label>
                        <select id="translation-select" class="w-full px-4 py-2 border border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200">
                            <option value="en.sahih">English (Sahih International)</option>
                            <option value="ur.maududi">Urdu (Maududi)</option>
                            <option value="fr.hamidullah">French (Hamidullah)</option>
                            <option value="es.bornez">Spanish (Bornez)</option>
                            <option value="de.zaidan" selected>German (Zaidan)</option>
                        </select>
                    </div>
                </div>

                <div class="quran-text bg-white rounded-lg p-6">
                    <div class="surah-header text-center mb-8 pb-6 border-b border-yellow-100">
                        <div class="surah-name text-2xl font-bold text-yellow-800">Loading...</div>
                        <div class="surah-translation text-gray-600">Please select a surah</div>
                    </div>
                    <div id="ayahs-container" class="space-y-8"></div>
                </div>
            </div>
        </section>

        <!-- Floating Bookmarks Button -->
        <button class="toggle-bookmarks fixed bottom-8 right-8 w-14 h-14 rounded-full bg-yellow-500 text-white shadow-lg hover:bg-yellow-600 transition-colors flex items-center justify-center z-50" id="toggle-bookmarks" title="Show Bookmarks">
            <i class="fas fa-bookmark text-2xl"></i>
        </button>
    </div>

    <!-- Footer -->
    <footer class="text-center py-8 text-yellow-900 mt-12 bg-gradient-to-b from-yellow-100 to-yellow-200 border-t border-yellow-200">
        <div class="max-w-4xl mx-auto px-4">
            <div class="mb-2">
                <i class="fas fa-leaf text-lg mr-2"></i> Baraka App – Muslimische Produktivität |
                <span class="italic text-gray-700">Mit Baraka zum Tag voller Segen.</span>
            </div>
            <div class="text-gray-500 text-sm">
                Version 1.0 &middot; Keine Daten werden an Server übermittelt – alles bleibt lokal im Browser.
            </div>
        </div>
    </footer>

    <!-- Add this before the closing body tag
    <div id="eventModal" class="event-modal">
        <div class="event-modal-content">
            <form id="eventForm" class="event-form">
                <input type="hidden" id="eventId">
                <div>
                    <label for="eventTitle">Title:</label>
                    <input type="text" id="eventTitle" required>
                </div>
                <div>
                    <label for="eventDescription">Description:</label>
                    <textarea id="eventDescription" rows="3"></textarea>
                </div>
                <div>
                    <label for="eventType">Type:</label>
                    <select id="eventType">
                        <option value="task">Task</option>
                        <option value="meeting">Meeting</option>
                        <option value="reminder">Reminder</option>
                    </select>
                </div>
                <div>
                    <label for="eventStart">Start:</label>
                    <input type="datetime-local" id="eventStart" required>
                </div>
                <div>
                    <label for="eventEnd">End:</label>
                    <input type="datetime-local" id="eventEnd" required>
                </div>
                <div class="event-form-buttons">
                    <button type="button" class="delete-event" id="deleteEvent" style="display: none;">Delete</button>
                    <button type="button" class="cancel-event" id="cancelEvent">Cancel</button>
                    <button type="submit" class="save-event">Save</button>
                </div>
            </form>
        </div>
    </div>
    -->

    <!-- Add the event modal HTML before the closing body tag -->
    <div id="eventModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-yellow-800" id="eventModalTitle">Neuer Eintrag</h3>
                <button onclick="closeEventModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="eventForm" class="space-y-4">
                <input type="hidden" id="eventId">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Titel</label>
                    <input type="text" id="eventTitle" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Typ</label>
                    <select id="eventType" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                        <option value="task">Aufgabe</option>
                        <option value="deep-work">Deep Work</option>
                        <option value="quran">Quran-Ziel</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Datum & Zeit</label>
                    <input type="datetime-local" id="eventDateTime" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" required>
                </div>
                <div id="durationField" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Dauer (Minuten)</label>
                    <input type="number" id="eventDuration" min="15" max="360" step="15" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200">
                </div>
                <div id="segmentField">
                    <label class="block text-sm font-medium text-gray-700">Segment</label>
                    <select id="eventSegment" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200">
                        <option value="Fajr">Fajr</option>
                        <option value="Dhuhr">Dhuhr</option>
                        <option value="Asr">Asr</option>
                        <option value="Maghrib">Maghrib</option>
                        <option value="Isha">Isha</option>
                    </select>
                </div>
                <div class="flex justify-between pt-4">
                    <button type="button" id="deleteEventBtn" onclick="deleteEvent()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all duration-200 hidden">
                        <i class="fas fa-trash mr-2"></i>Löschen
                    </button>
                    <div class="space-x-2">
                        <button type="button" onclick="closeEventModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all duration-200">
                            Abbrechen
                        </button>
                        <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-all duration-200">
                            Speichern
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add bottom navigation HTML before closing body tag -->
    <nav class="bottom-nav">
        <div class="bottom-nav-scroll">
            <a href="#prayer-times" class="bottom-nav-item">
                <i class="fas fa-mosque"></i>
                <span>Gebetszeiten</span>
            </a>
            <a href="#planner" class="bottom-nav-item">
                <i class="fas fa-calendar-day"></i>
                <span>Tagesplanung</span>
            </a>
            <a href="#deep-work" class="bottom-nav-item">
                <i class="fas fa-brain"></i>
                <span>Deep Work</span>
            </a>
            <a href="#spiritual" class="bottom-nav-item">
                <i class="fas fa-heart"></i>
                <span>Spiritualität</span>
            </a>
            <a href="#calendar-view" class="bottom-nav-item">
                <i class="fas fa-calendar-alt"></i>
                <span>Kalender</span>
            </a>
            <a href="#quran-reader" class="bottom-nav-item">
                <i class="fas fa-book-quran"></i>
                <span>Quran</span>
            </a>
        </div>
    </nav>

    <!-- Add a loading indicator -->
    <div id="loading-indicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-yellow-500"></div>
    </div>

<script>
// Constants and Configuration
const SEGMENTS = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
const SEGMENT_LABELS = {
    Fajr: 'Fajr<br><span class="text-xs text-yellow-800">(Morgendämmerung)</span>',
    Dhuhr: 'Dhuhr<br><span class="text-xs text-yellow-800">(Mittag)</span>',
    Asr: 'Asr<br><span class="text-xs text-yellow-800">(Nachmittag)</span>',
    Maghrib: 'Maghrib<br><span class="text-xs text-yellow-800">(Sonnenuntergang)</span>',
    Isha: 'Isha<br><span class="text-xs text-yellow-800">(Nacht)</span>'
};

// State Management
const state = {
    plannerData: SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:{}}), {}),
    deepWorkData: SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {}),
    quranGoals: [],
    prayerTimes: {},
    location: {
        city: 'Berlin',
        country: 'Germany'
    }
};

// DOM Elements
const elements = {
    plannerGrid: document.getElementById('planner-grid'),
    deepWorkChart: document.getElementById('deepwork-chart'),
    quranGoalsList: document.getElementById('quran-goals'),
    prayerTimesDisplay: document.getElementById('prayer-times-display')
};

// Auth State
let isLoginMode = true;
let currentUser = null;
let authToken = null;

// Auth DOM Elements
const authModal = document.getElementById('authModal');
const authForm = document.getElementById('authForm');
const authModalTitle = document.getElementById('authModalTitle');
const authButtonText = document.getElementById('authButtonText');
const toggleAuthText = document.getElementById('toggleAuthText');
const usernameField = document.getElementById('usernameField');
const loginButton = document.getElementById('loginButton');
const userInfo = document.getElementById('userInfo');
const userName = document.getElementById('userName');

// Auth Functions
function openAuthModal(mode) {
    isLoginMode = mode === 'login';
    updateAuthModal();
    authModal.style.display = 'block';
    setTimeout(() => {
        authModal.classList.add('show');
    }, 10);
}

function closeAuthModal() {
    authModal.classList.remove('show');
    setTimeout(() => {
        authModal.style.display = 'none';
    }, 300);
}

function toggleAuthMode() {
    isLoginMode = !isLoginMode;
    updateAuthModal();
}

function updateAuthModal() {
    authModalTitle.textContent = isLoginMode ? 'Anmelden' : 'Registrieren';
    authButtonText.textContent = isLoginMode ? 'Anmelden' : 'Registrieren';
    toggleAuthText.textContent = isLoginMode ? 'Kein Konto? Registrieren' : 'Bereits registriert? Anmelden';
    usernameField.classList.toggle('hidden', isLoginMode);
}

// Add loadFromLocal function before window.onload
function loadFromLocal() {
    if (authToken) return; // Don't load from local if user is authenticated
    
    try {
        const plannerData = localStorage.getItem('baraka-planner');
        const deepWorkData = localStorage.getItem('baraka-deepwork');
        const qGoals = localStorage.getItem('baraka-qgoals');
        
        if (plannerData) {
            const parsed = JSON.parse(plannerData);
            // Convert old format to new format if necessary
            if (Array.isArray(parsed[SEGMENTS[0]])) {
                SEGMENTS.forEach(seg => {
                    state.plannerData[seg] = { [new Date().toISOString().split('T')[0]]: parsed[seg].map(title => ({
                        id: 'task_' + Date.now() + Math.random(),
                        title,
                        segment: seg,
                        date: new Date().toISOString().split('T')[0]
                    })) };
                });
            } else {
                state.plannerData = parsed;
            }
        }
        if (deepWorkData) state.deepWorkData = JSON.parse(deepWorkData);
        if (qGoals) state.quranGoals = JSON.parse(qGoals);
    } catch (error) {
        console.error('Error loading local data:', error);
    }
}

// Fix handleAuth function
async function handleAuth(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const username = !isLoginMode ? document.getElementById('username').value : null;

    console.log('Attempting auth:', isLoginMode ? 'login' : 'register', { email, username });

    try {
        // First test the server connection
        try {
            const testResponse = await fetch('http://localhost:3000/api/test');
            const testData = await testResponse.json();
            console.log('Server test response:', testData);
        } catch (testError) {
            console.error('Server test failed:', testError);
            throw new Error('Server connection failed. Please check if the server is running.');
        }

        // Proceed with authentication
        const response = await fetch(`http://localhost:3000/api/${isLoginMode ? 'login' : 'register'}`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(isLoginMode ? { email, password } : { email, password, username }),
            credentials: 'include'
        });

        console.log('Response status:', response.status);
        
        let data;
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            data = await response.json();
            console.log('Response data:', data);
        } else {
            console.error('Invalid content type:', contentType);
            throw new Error('Server response was not JSON');
        }
        
        if (response.ok) {
            authToken = data.token;
            currentUser = data.user;
            updateUI();
            closeAuthModal();
            loadUserData();
            // Clear form
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            if (!isLoginMode) document.getElementById('username').value = '';
        } else {
            throw new Error(data.message || 'Authentication failed');
        }
    } catch (error) {
        console.error('Auth error:', error);
        alert(error.message || 'Ein Fehler ist aufgetreten. Bitte überprüfen Sie Ihre Verbindung zum Server.');
    }
}

function logout() {
    authToken = null;
    currentUser = null;
    updateUI();
    state.plannerData = SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {});
    state.deepWorkData = SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {});
    state.quranGoals = [];
    renderPlannerGrid();
    renderDeepWorkChart();
    renderQuranGoals();
}

function updateUI() {
    if (currentUser) {
        loginButton.classList.add('hidden');
        userInfo.classList.remove('hidden');
        userName.textContent = currentUser.username;
    } else {
        loginButton.classList.remove('hidden');
        userInfo.classList.add('hidden');
    }
}

// API Functions
async function loadUserData() {
    if (!authToken) return;

    try {
        const response = await fetch('http://localhost:3000/api/user/data', {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
            const data = await response.json();
            // Initialize with empty data if not present
            state.plannerData = data.plannerData || SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {});
            state.deepWorkData = data.deepWorkData || SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {});
            state.quranGoals = data.quranGoals || [];
            renderPlannerGrid();
            renderDeepWorkChart();
            renderQuranGoals();
        } else {
            console.log('Failed to load user data:', response.status);
            // Initialize with empty state if loading fails
            state.plannerData = SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {});
            state.deepWorkData = SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {});
            state.quranGoals = [];
            renderPlannerGrid();
            renderDeepWorkChart();
            renderQuranGoals();
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        // Initialize with empty state if loading fails
        state.plannerData = SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {});
        state.deepWorkData = SEGMENTS.reduce((obj, seg) => ({...obj, [seg]:[]}), {});
        state.quranGoals = [];
        renderPlannerGrid();
        renderDeepWorkChart();
        renderQuranGoals();
    }
}

async function saveUserData() {
    if (!authToken) return;

    try {
        await fetch('http://localhost:3000/api/user/data', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                plannerData: state.plannerData,
                deepWorkData: state.deepWorkData,
                quranGoals: state.quranGoals
            })
        });
    } catch (error) {
        console.error('Error saving user data:', error);
    }
}

// Event Listeners
authForm.addEventListener('submit', handleAuth);

// Planner Functions
async function renderPlannerGrid() {
    elements.plannerGrid.innerHTML = '';
    
    // Get current date
    const currentDate = document.getElementById('task-date')?.value || new Date().toISOString().split('T')[0];
    
    try {
        // Get prayer times for the current date
        const times = await getPrayerTimesForDate(currentDate);
        console.log('Prayer times for', currentDate, ':', times);
        
        SEGMENTS.forEach(seg => {
            const box = document.createElement('div');
            box.className = 'bg-yellow-100 rounded-lg p-3 shadow-sm mb-2 flex flex-col min-h-32';
            
            // Get prayer time for this segment
            const prayerTime = times ? times[seg] : '...';
            const now = new Date();
            const isPrayerTimePassed = times ? new Date(`${currentDate}T${prayerTime}`) < now : false;
            
            box.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="font-bold text-yellow-700">${SEGMENT_LABELS[seg]}</div>
                    <div class="flex items-center">
                        <span class="text-sm ${isPrayerTimePassed ? 'text-gray-500' : 'text-yellow-600 font-semibold'}">
                            <i class="fas fa-clock mr-1"></i>${prayerTime || '...'}
                        </span>
                        ${isPrayerTimePassed ? 
                            `<span class="ml-2 text-xs text-gray-500"><i class="fas fa-check"></i></span>` : 
                            ''}
                    </div>
                </div>
                <ul id="tasks-${seg}" class="list-disc ml-6 min-h-6"></ul>
            `;
            elements.plannerGrid.appendChild(box);
            renderTasks(seg, currentDate);
        });
    } catch (error) {
        console.error('Error rendering planner grid:', error);
    }
}

function renderTasks(segment, date) {
    const ul = document.getElementById(`tasks-${segment}`);
    if (!ul) {
        console.error('Task container not found for segment:', segment);
        return;
    }

    ul.innerHTML = '';
    
    const tasksForDate = state.plannerData[segment][date] || [];
    console.log('Rendering tasks for', segment, date, ':', tasksForDate);

    tasksForDate.forEach((taskObj, idx) => {
        const li = document.createElement('li');
        li.className = 'task-item flex justify-between items-center my-2 p-2 rounded-lg text-gray-800 slide-in';
        li.style.animationDelay = `${idx * 50}ms`;
        
        // Create the remove button with a more prominent style
        const removeButton = document.createElement('button');
        removeButton.className = 'ml-3 bg-red-100 hover:bg-red-200 text-red-600 hover:text-red-700 p-2 rounded-lg transition-colors duration-200';
        removeButton.innerHTML = '<i class="fas fa-trash"></i>';
        removeButton.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (confirm('Möchten Sie diese Aufgabe wirklich löschen?')) {
                removeTask(segment, date, idx);
            }
        };

        li.innerHTML = `
            <span class="flex-1">${taskObj.title}</span>
        `;
        li.appendChild(removeButton);
        ul.appendChild(li);
    });
}

function addTask(e) {
    e.preventDefault();
    const taskTitle = document.getElementById('task-input').value.trim();
    const segment = document.getElementById('segment-select').value;
    const date = document.getElementById('task-date').value;
    
    if (taskTitle && date) {
        // Initialize the date object if it doesn't exist
        if (!state.plannerData[segment]) {
            state.plannerData[segment] = {};
        }
        if (!state.plannerData[segment][date]) {
            state.plannerData[segment][date] = [];
        }
        
        // Create task object with unique ID
        const taskObj = {
            id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            title: taskTitle,
            segment: segment,
            date: date,
            created: new Date().toISOString()
        };
        
        console.log('Adding new task:', taskObj);
        
        // Add to planner data
        state.plannerData[segment][date].push(taskObj);
        
        // Save and render
        saveToLocal();
        renderTasks(segment, date);
        
        // Clear input
        document.getElementById('task-input').value = '';
        
        // Refresh calendar if it exists
        if (window.mainCalendar) {
            window.mainCalendar.refetchEvents();
        }

        console.log('Task added successfully');
    }
}

function removeTask(segment, date, idx) {
    console.log('Removing task:', { segment, date, idx });
    
    try {
        // Get the task before removing it
        const taskToRemove = state.plannerData[segment][date][idx];
        console.log('Task to remove:', taskToRemove);

        // Remove from state
        state.plannerData[segment][date].splice(idx, 1);
        
        // If no more tasks for this date in this segment, clean up the empty object
        if (state.plannerData[segment][date].length === 0) {
            delete state.plannerData[segment][date];
        }

        // Save to local storage
        saveToLocal();
        
        // Re-render the tasks for this segment
        renderTasks(segment, date);
        
        // Refresh calendar if it exists
        if (window.mainCalendar) {
            window.mainCalendar.refetchEvents();
        }

        console.log('Task removed successfully');
    } catch (error) {
        console.error('Error removing task:', error);
    }
}

// Deep Work Functions
let deepWorkChart = null;

function renderDeepWorkChart() {
    const ctx = elements.deepWorkChart.getContext('2d');
    
    // Get current date
    const currentDate = new Date().toISOString().split('T')[0];
    
    // Filter data for current date and calculate totals
    const data = SEGMENTS.map(s => {
        return state.deepWorkData[s]
            .filter(entry => entry.date === currentDate)
            .reduce((sum, e) => sum + e.duration, 0);
    });
    
    if (deepWorkChart) deepWorkChart.destroy();
    
    deepWorkChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: SEGMENTS,
            datasets: [{
                label: 'Deep Work (Minuten)',
                data,
                backgroundColor: ['#fde68a','#fbbf24','#f59e42','#f59e42','#fde68a'],
                borderRadius: 5
            }]
        },
        options: {
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: `Deep Work Verteilung (${new Date().toLocaleDateString('de-DE')})`,
                    font: { size: 14 }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    ticks: { 
                        stepSize: 30, 
                        font: {size:12} 
                    } 
                },
                x: { 
                    ticks: { 
                        font: {size:14, weight:'bold'} 
                    } 
                }
            },
            animation: false,
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function addDeepWorkSession(e) {
    e.preventDefault();
    const title = document.getElementById('deepwork-title').value.trim();
    const segment = document.getElementById('deepwork-segment').value;
    const date = document.getElementById('deepwork-date').value;
    const duration = parseInt(document.getElementById('deepwork-duration').value, 10);
    
    if(title && segment && date && duration) {
        // Add to deep work data
        state.deepWorkData[segment].push({ title, date, duration });
        saveToLocal();
        renderDeepWorkChart();

        // Add to calendar
        const startDate = new Date(date);
        const endDate = new Date(startDate);
        endDate.setMinutes(startDate.getMinutes() + duration);

        const calendarEvent = {
            id: 'dw_' + Date.now(),
            title: `Deep Work: ${title}`,
            start: startDate.toISOString(),
            end: endDate.toISOString(),
            description: `Deep Work Session - ${duration} Minuten`,
            type: 'deep-work',
            backgroundColor: '#22c55e', // green color for deep work
            extendedProps: {
                segment: segment,
                duration: duration
            }
        };

        // Add event to calendar
        const calendarEl = document.getElementById('calendar');
        const calendar = calendarEl._fullCalendar;
        if (calendar) {
            calendar.addEvent(calendarEvent);

            // Save to server if authenticated
            if (authToken) {
                fetch('/api/events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(calendarEvent)
                })
                .then(response => response.json())
                .then(data => console.log('Deep work event saved:', data))
                .catch(error => console.error('Error saving deep work event:', error));
            }
        }

        // Clear form
        document.getElementById('deepwork-title').value = '';
        document.getElementById('deepwork-duration').value = '';
        document.getElementById('deepwork-date').value = '';
    }
}

// Quran Goals Functions
function renderQuranGoals() {
    elements.quranGoalsList.innerHTML = '';
    state.quranGoals.forEach((goal, idx) => {
        const li = document.createElement('li');
        li.className = 'task-item flex items-center justify-between p-2 rounded-lg slide-in';
        li.style.animationDelay = `${idx * 50}ms`;
        li.innerHTML = `
            <span class="flex-1">${goal}</span>
            <button onclick="removeQuranGoal(${idx})" class="ml-3 text-red-500 hover:text-red-700 transition-colors p-1 hover:bg-red-50 rounded">
                <i class="fas fa-trash"></i>
            </button>
        `;
        elements.quranGoalsList.appendChild(li);
    });
}

function addQuranGoal(e) {
    e.preventDefault();
    const goal = document.getElementById('quran-todo').value.trim();
    if(goal) {
        state.quranGoals.push(goal);
        saveToLocal();
        renderQuranGoals();
        document.getElementById('quran-todo').value = '';
    }
}

function removeQuranGoal(idx) {
    state.quranGoals.splice(idx, 1);
    saveToLocal();
    renderQuranGoals();
}

// Prayer Times Functions
async function getPrayerTimesByCity(city) {
    try {
        const today = new Date();
        const url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=&method=4&date=${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data?.data?.timings) {
            updatePrayerTimes(data.data.timings);
            return data.data.timings;
        }
        return null;
    } catch (error) {
        console.error('Error fetching prayer times:', error);
        return null;
    }
}

async function getPrayerTimesByGeo(lat, lng) {
    try {
        const today = new Date();
        const url = `https://api.aladhan.com/v1/timings/${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}?latitude=${lat}&longitude=${lng}&method=4`;
        const response = await fetch(url);
        const data = await response.json();
        return (data?.data?.timings) || null;
    } catch (error) {
        console.error('Error fetching prayer times by geo:', error);
        return null;
    }
}

function renderPrayerTimes(times) {
    elements.prayerTimesDisplay.innerHTML = '';
    const keys = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
    
    keys.forEach((k, index) => {
        const div = document.createElement('div');
        div.className = 'prayer-time-card flex flex-col items-center border border-yellow-200 rounded-xl py-4 px-2 bg-white shadow-md scale-in';
        div.style.animationDelay = `${index * 100}ms`;
        div.innerHTML = `
            <span class="font-bold text-yellow-700 mb-2">${k}</span>
            <span class="text-2xl font-mono text-yellow-900">${times[k]}</span>
        `;
        elements.prayerTimesDisplay.appendChild(div);
    });
}

async function setLocation(e) {
    e.preventDefault();
    const city = document.getElementById('city').value;
    renderPrayerTimes({Fajr:'... ', Dhuhr:'... ', Asr:'... ', Maghrib:'... ', Isha:'... '});
    
    try {
        const times = await getPrayerTimesByCity(city);
        if(times) {
            renderPrayerTimes(times);
            // Update state with new location
            state.location.city = city;
            state.location.country = 'Germany'; // Default to Germany
            // Clear cached prayer times to force refresh with new location
            state.prayerTimes = {};
            localStorage.removeItem('baraka-location');
            localStorage.setItem('baraka-location', JSON.stringify(state.location));
            // Clear all prayer times cache for the old location
            Object.keys(localStorage)
                .filter(key => key.startsWith('prayer-times-'))
                .forEach(key => localStorage.removeItem(key));
            // Refresh planner grid to show new prayer times
            renderPlannerGrid();
        } else {
            alert('Gebetszeiten konnten nicht geladen werden.');
        }
    } catch (error) {
        console.error('Error setting location:', error);
        alert('Fehler beim Laden der Gebetszeiten.');
    }
    
    return false;
}

function detectLocation() {
    if(navigator.geolocation) {
        renderPrayerTimes({Fajr:'... ', Dhuhr:'... ', Asr:'... ', Maghrib:'... ', Isha:'... '});
        
        navigator.geolocation.getCurrentPosition(
            async pos => {
                try {
                    const times = await getPrayerTimesByGeo(pos.coords.latitude, pos.coords.longitude);
                    if(times) {
                        renderPrayerTimes(times);
                        // Get city name from coordinates using reverse geocoding
                        try {
                            const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=de`);
                            const data = await response.json();
                            if(data.city) {
                                state.location.city = data.city;
                                state.location.country = data.countryName;
                                localStorage.setItem('baraka-location', JSON.stringify(state.location));
                                document.getElementById('city').value = data.city;
                            }
                        } catch (error) {
                            console.error('Error getting city name:', error);
                        }
                        // Clear cached prayer times and refresh planner
                        state.prayerTimes = {};
                        renderPlannerGrid();
                    }
                } catch (error) {
                    alert('Fehler beim Laden der Gebetszeiten.');
                }
            },
            () => alert('Standortabfrage wurde abgebrochen.')
        );
    } else {
        alert('Geolokalisierung wird nicht unterstützt.');
    }
}

// Modify existing functions to save to server
function saveToLocal() {
    localStorage.setItem('baraka-planner', JSON.stringify(state.plannerData));
    localStorage.setItem('baraka-deepwork', JSON.stringify(state.deepWorkData));
    localStorage.setItem('baraka-qgoals', JSON.stringify(state.quranGoals));
    if (authToken) {
        saveUserData();
    }
}

// Add a function to test server connection
async function testServerConnection() {
    try {
        const response = await fetch('http://localhost:3000/api/test');
        const data = await response.json();
        console.log('Server connection test:', data);
        return true;
    } catch (error) {
        console.error('Server connection test failed:', error);
        return false;
    }
}

// Modify window.onload to include server test
window.onload = async () => {
    const serverAvailable = await testServerConnection();
    if (!serverAvailable) {
        console.error('Server is not available');
        alert('Server ist nicht erreichbar. Bitte stellen Sie sicher, dass der Server läuft.');
    }
    
    loadFromLocal();
    renderPlannerGrid();
    renderDeepWorkChart();
    renderQuranGoals();
    
    // Load saved location
    const savedLocation = localStorage.getItem('baraka-location');
    if (savedLocation) {
        state.location = JSON.parse(savedLocation);
        document.getElementById('city').value = state.location.city;
    }
    
    // Load initial prayer times for saved location
    getPrayerTimesByCity(state.location.city)
        .then(times => {
            if(times) renderPrayerTimes(times);
        })
        .catch(error => console.error('Error loading initial prayer times:', error));

    // Add immediate server test
    console.log('Testing server connection...');
    fetch('http://localhost:3000/api/test')
        .then(response => response.json())
        .then(data => {
            console.log('✅ Server is connected and running:', data);
            // Add visual indicator by changing background color
            document.body.classList.remove('bg-yellow-50');
            document.body.classList.add('bg-green-50');
        })
        .catch(error => {
            console.error('❌ Server connection failed:', error);
            // Add visual indicator by changing background color
            document.body.classList.remove('bg-green-50');
            document.body.classList.add('bg-yellow-50');
        });

    // Request notification permission
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
    
    // Start prayer time checker
    setInterval(checkPrayerTimes, 60000); // Check every minute
    checkPrayerTimes(); // Check immediately
};

// Calendar State and Elements
let calendar;
let currentEntry = null;

// Initialize Calendar
document.addEventListener('DOMContentLoaded', function() {
    const mainCalendarEl = document.getElementById('main-calendar');
    const mainCalendar = new FullCalendar.Calendar(mainCalendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        locale: 'de',
        editable: true,
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        nowIndicator: true,
        slotMinTime: '04:00:00',
        slotMaxTime: '24:00:00',
        loading: function(isLoading) {
            if (isLoading) {
                mainCalendarEl.classList.add('opacity-50');
            } else {
                mainCalendarEl.classList.remove('opacity-50');
            }
        },
        select: function(info) {
            openEventModal(null, info.start);
        },
        eventClick: function(info) {
            if (info.event.extendedProps.type !== 'prayer') {
                openEventModal(info.event);
            }
        },
        eventDrop: function(info) {
            // Handle event drag & drop
            const event = info.event;
            const type = event.extendedProps.type;
            const oldDate = info.oldEvent.start.toISOString().split('T')[0];
            const newDate = event.start.toISOString().split('T')[0];
            const segment = event.extendedProps.segment;

            if (type === 'task' && segment) {
                // Update task date in plannerData
                if (state.plannerData[segment]?.[oldDate]) {
                    const taskIndex = state.plannerData[segment][oldDate].findIndex(t => t.id === event.id);
                    if (taskIndex !== -1) {
                        const task = state.plannerData[segment][oldDate][taskIndex];
                        // Remove from old date
                        state.plannerData[segment][oldDate].splice(taskIndex, 1);
                        if (state.plannerData[segment][oldDate].length === 0) {
                            delete state.plannerData[segment][oldDate];
                        }
                        // Add to new date
                        if (!state.plannerData[segment][newDate]) {
                            state.plannerData[segment][newDate] = [];
                        }
                        task.date = newDate;
                        state.plannerData[segment][newDate].push(task);
                    }
                }
            } else if (type === 'deep-work' && segment) {
                // Update deep work session date
                const sessions = state.deepWorkData[segment];
                const sessionIndex = sessions.findIndex(s => s.id === event.id);
                if (sessionIndex !== -1) {
                    sessions[sessionIndex].date = newDate;
                }
            }

            saveToLocal();
            renderPlannerGrid();
            renderDeepWorkChart();
        },
        eventSources: [
            {
                events: function(info, successCallback, failureCallback) {
                    try {
                        const events = [];
                        
                        // Only show events for active filters
                        if (activeFilters.includes('all') || activeFilters.includes('task')) {
                            // Add tasks
                            Object.entries(state.plannerData).forEach(([segment, dates]) => {
                                Object.entries(dates).forEach(([date, tasks]) => {
                                    tasks.forEach(task => {
                                        events.push({
                                            id: task.id,
                                            title: task.title,
                                            start: date,
                                            allDay: true,
                                            backgroundColor: getEventColor('task'),
                                            borderColor: getEventColor('task'),
                                            extendedProps: {
                                                type: 'task',
                                                segment: segment
                                            }
                                        });
                                    });
                                });
                            });
                        }

                        if (activeFilters.includes('all') || activeFilters.includes('deep-work')) {
                            // Add Deep Work sessions
                            Object.entries(state.deepWorkData).forEach(([segment, sessions]) => {
                                sessions.forEach(session => {
                                    events.push({
                                        id: session.id,
                                        title: `Deep Work: ${session.title}`,
                                        start: session.date,
                                        allDay: true,
                                        backgroundColor: getEventColor('deep-work'),
                                        borderColor: getEventColor('deep-work'),
                                        extendedProps: {
                                            type: 'deep-work',
                                            segment: segment,
                                            duration: session.duration
                                        }
                                    });
                                });
                            });
                        }

                        if (activeFilters.includes('all') || activeFilters.includes('quran')) {
                            // Add Quran goals
                            state.quranGoals.forEach((goal, index) => {
                                events.push({
                                    id: goal.id || `quran_${index}`,
                                    title: goal.title || goal,
                                    start: goal.date || new Date(),
                                    allDay: true,
                                    backgroundColor: getEventColor('quran'),
                                    borderColor: getEventColor('quran'),
                                    extendedProps: {
                                        type: 'quran'
                                    }
                                });
                            });
                        }

                        if (activeFilters.includes('all') || activeFilters.includes('prayer')) {
                            // Add prayer times
                            const start = info.start;
                            const end = info.end;
                            const currentDate = new Date(start);

                            while (currentDate < end) {
                                const dateStr = currentDate.toISOString().split('T')[0];
                                const times = state.prayerTimes[dateStr];
                                if (times) {
                                    Object.entries(times).forEach(([prayer, time]) => {
                                        events.push({
                                            id: `prayer_${dateStr}_${prayer}`,
                                            title: `${prayer} Gebet`,
                                            start: `${dateStr}T${time}`,
                                            allDay: false,
                                            backgroundColor: getEventColor('prayer'),
                                            borderColor: getEventColor('prayer'),
                                            extendedProps: {
                                                type: 'prayer'
                                            }
                                        });
                                    });
                                }
                                currentDate.setDate(currentDate.getDate() + 1);
                            }
                        }

                        successCallback(events);
                    } catch (error) {
                        console.error('Error loading calendar events:', error);
                        failureCallback(error);
                    }
                }
            }
        ]
    });

    // Handle event form submission
    document.getElementById('eventForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            id: document.getElementById('eventId').value || 'event_' + Date.now(),
            title: document.getElementById('eventTitle').value,
            type: document.getElementById('eventType').value,
            start: document.getElementById('eventDateTime').value,
            segment: document.getElementById('eventSegment').value,
            duration: document.getElementById('eventType').value === 'deep-work' ? 
                parseInt(document.getElementById('eventDuration').value) : null
        };
        
        // Create or update event
        if (formData.id.startsWith('event_')) {
            // New event
            const eventData = {
                id: formData.id,
                title: formData.title,
                start: formData.start,
                allDay: false,
                backgroundColor: getEventColor(formData.type),
                borderColor: getEventColor(formData.type),
                extendedProps: {
                    type: formData.type,
                    segment: formData.segment,
                    duration: formData.duration
                }
            };
            
            // Add to calendar
            mainCalendar.addEvent(eventData);
            
            // Add to appropriate state
            if (formData.type === 'task') {
                if (!state.plannerData[formData.segment]) {
                    state.plannerData[formData.segment] = {};
                }
                const date = formData.start.split('T')[0];
                if (!state.plannerData[formData.segment][date]) {
                    state.plannerData[formData.segment][date] = [];
                }
                state.plannerData[formData.segment][date].push({
                    id: formData.id,
                    title: formData.title,
                    segment: formData.segment,
                    date: date
                });
            } else if (formData.type === 'deep-work') {
                if (!state.deepWorkData[formData.segment]) {
                    state.deepWorkData[formData.segment] = [];
                }
                state.deepWorkData[formData.segment].push({
                    id: formData.id,
                    title: formData.title,
                    date: formData.start.split('T')[0],
                    duration: formData.duration,
                    segment: formData.segment
                });
            } else if (formData.type === 'quran') {
                state.quranGoals.push({
                    id: formData.id,
                    title: formData.title,
                    date: formData.start.split('T')[0]
                });
            }
        } else {
            // Update existing event
            const event = mainCalendar.getEventById(formData.id);
            if (event) {
                event.setProp('title', formData.title);
                event.setStart(formData.start);
                event.setExtendedProp('type', formData.type);
                event.setExtendedProp('segment', formData.segment);
                event.setExtendedProp('duration', formData.duration);
                event.setProp('backgroundColor', getEventColor(formData.type));
                event.setProp('borderColor', getEventColor(formData.type));
            }
        }
        
        // Save changes
        saveToLocal();
        
        // Update UI
        renderPlannerGrid();
        renderDeepWorkChart();
        renderQuranGoals();
        
        closeEventModal();
    });

    mainCalendar.render();
    window.mainCalendar = mainCalendar;
});

// Add helper functions for calendar
function getEventIcon(type) {
    switch(type) {
        case 'prayer': return 'mosque';
        case 'deep-work': return 'brain';
        case 'task': return 'tasks';
        case 'quran': return 'book-open';
        default: return 'calendar';
    }
}

let activeFilters = ['all'];

function toggleEventType(type) {
    if (type === 'all') {
        activeFilters = ['all'];
    } else {
        const index = activeFilters.indexOf('all');
        if (index > -1) {
            activeFilters.splice(index, 1);
        }
        
        const typeIndex = activeFilters.indexOf(type);
        if (typeIndex > -1) {
            activeFilters.splice(typeIndex, 1);
        } else {
            activeFilters.push(type);
        }
        
        if (activeFilters.length === 0) {
            activeFilters = ['all'];
        }
    }
    
    // Update button styles
    document.querySelectorAll('[onclick^="toggleEventType"]').forEach(button => {
        const buttonType = button.getAttribute('onclick').match(/'(.+)'/)[1];
        if (activeFilters.includes('all') || activeFilters.includes(buttonType)) {
            button.classList.add('ring-2', 'ring-offset-2', 'ring-yellow-500');
        } else {
            button.classList.remove('ring-2', 'ring-offset-2', 'ring-yellow-500');
        }
    });
    
    // Refresh calendar
    if (window.mainCalendar) {
        window.mainCalendar.refetchEvents();
    }
}

// Update the getPrayerTimesForDate function to handle errors better
async function getPrayerTimesForDate(date) {
    try {
        // Check if we already have the times in state
        if (state.prayerTimes[date]) {
            return state.prayerTimes[date];
        }

        // Try to get from localStorage first
        const cachedTimes = localStorage.getItem(`prayer-times-${date}-${state.location.city}`);
        if (cachedTimes) {
            const parsed = JSON.parse(cachedTimes);
            state.prayerTimes[date] = parsed;
            return parsed;
        }

        // Load saved location from localStorage if available
        const savedLocation = localStorage.getItem('baraka-location');
        if (savedLocation) {
            state.location = JSON.parse(savedLocation);
        }

        // If not in cache, fetch from API using saved location
        const dateObj = new Date(date);
        const url = `https://api.aladhan.com/v1/timingsByCity/${dateObj.getDate()}-${dateObj.getMonth()+1}-${dateObj.getFullYear()}?city=${encodeURIComponent(state.location.city)}&country=${encodeURIComponent(state.location.country)}&method=4`;
        
        console.log('Fetching prayer times from:', url);
        const response = await fetch(url);
        const data = await response.json();
        
        if (data?.data?.timings) {
            const times = {
                Fajr: data.data.timings.Fajr,
                Dhuhr: data.data.timings.Dhuhr,
                Asr: data.data.timings.Asr,
                Maghrib: data.data.timings.Maghrib,
                Isha: data.data.timings.Isha
            };
            
            // Store in state and localStorage with location-specific key
            state.prayerTimes[date] = times;
            localStorage.setItem(`prayer-times-${date}-${state.location.city}`, JSON.stringify(times));
            
            console.log('Cached prayer times for', date, ':', times);
            return times;
        }
        console.warn('No prayer times data received for', date);
        return null;
    } catch (error) {
        console.error('Error fetching prayer times for', date, ':', error);
        return null;
    }
}

// Add event listener for date changes to update prayer times
document.getElementById('task-date')?.addEventListener('change', function() {
    updateDateDisplay();
    renderPlannerGrid();
});

// Initialize the page with current date and prayer times
window.addEventListener('load', function() {
    const today = new Date().toISOString().split('T')[0];
    if (document.getElementById('task-date')) {
        document.getElementById('task-date').value = today;
    }
    if (document.getElementById('deepwork-date')) {
        document.getElementById('deepwork-date').value = today;
    }
    updateDateDisplay();
    
    // Load saved location
    const savedLocation = localStorage.getItem('baraka-location');
    if (savedLocation) {
        state.location = JSON.parse(savedLocation);
        if (document.getElementById('city')) {
            document.getElementById('city').value = state.location.city;
        }
    }
    
    // Initial render
    renderPlannerGrid();
    renderDeepWorkChart();
    renderQuranGoals();
    
    // Initialize Quran reader
    loadQuran();
});

// Calendar event handling functions
function openEventModal(event = null, start = null) {
    const modal = document.getElementById('eventModal');
    const form = document.getElementById('eventForm');
    const deleteBtn = document.getElementById('deleteEventBtn');
    const titleEl = document.getElementById('eventModalTitle');
    const typeEl = document.getElementById('eventType');
    const durationField = document.getElementById('durationField');
    
    // Reset form
    form.reset();
    
    if (event) {
        // Editing existing event
        titleEl.textContent = 'Eintrag bearbeiten';
        document.getElementById('eventId').value = event.id;
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventType').value = event.extendedProps.type;
        document.getElementById('eventDateTime').value = event.start.toISOString().slice(0, 16);
        
        if (event.extendedProps.duration) {
            document.getElementById('eventDuration').value = event.extendedProps.duration;
        }
        if (event.extendedProps.segment) {
            document.getElementById('eventSegment').value = event.extendedProps.segment;
        }
        
        deleteBtn.classList.remove('hidden');
    } else {
        // Creating new event
        titleEl.textContent = 'Neuer Eintrag';
        document.getElementById('eventId').value = '';
        if (start) {
            document.getElementById('eventDateTime').value = start.toISOString().slice(0, 16);
        }
        deleteBtn.classList.add('hidden');
    }
    
    // Show/hide duration field based on type
    typeEl.onchange = function() {
        durationField.classList.toggle('hidden', this.value !== 'deep-work');
    };
    
    modal.style.display = 'block';
}

function closeEventModal() {
    document.getElementById('eventModal').style.display = 'none';
}

function deleteEvent() {
    const eventId = document.getElementById('eventId').value;
    if (!eventId) return;
    
    if (confirm('Möchten Sie diesen Eintrag wirklich löschen?')) {
        const event = window.mainCalendar.getEventById(eventId);
        if (event) {
            // Remove from calendar
            event.remove();
            
            // Remove from state based on event type
            const type = event.extendedProps.type;
            const date = event.start.toISOString().split('T')[0];
            const segment = event.extendedProps.segment;
            
            if (type === 'task' && segment) {
                // Remove task from plannerData
                if (state.plannerData[segment]?.[date]) {
                    state.plannerData[segment][date] = state.plannerData[segment][date].filter(
                        task => task.id !== eventId
                    );
                    if (state.plannerData[segment][date].length === 0) {
                        delete state.plannerData[segment][date];
                    }
                }
            } else if (type === 'deep-work') {
                // Remove deep work session
                if (state.deepWorkData[segment]) {
                    state.deepWorkData[segment] = state.deepWorkData[segment].filter(
                        session => session.id !== eventId
                    );
                }
            } else if (type === 'quran') {
                // Remove Quran goal
                state.quranGoals = state.quranGoals.filter(goal => goal.id !== eventId);
            }
            
            // Save changes
            saveToLocal();
            
            // Update UI
            renderPlannerGrid();
            renderDeepWorkChart();
            renderQuranGoals();
        }
        
        closeEventModal();
    }
}

// Add Quran Reader Functions
let bookmarks = JSON.parse(localStorage.getItem('quran-bookmarks')) || [];

// Add this before other Quran reader functions
async function loadQuran() {
    console.log('Loading Quran reader...');
    try {
        // Load surah list
        const response = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await response.json();
        const surahSelect = document.getElementById('surah-select');
        
        if (!surahSelect) {
            console.error('Surah select element not found');
            return;
        }
        
        console.log('Fetched surahs:', data.data.length);
        
        data.data.forEach(surah => {
            surahSelect.innerHTML += `
                <option value="${surah.number}">
                    ${surah.number}. ${surah.englishName} (${surah.name})
                </option>
            `;
        });
        
        // Event listeners
        surahSelect.addEventListener('change', loadSurah);
        document.getElementById('translation-select')?.addEventListener('change', loadSurah);
        document.getElementById('toggle-bookmarks')?.addEventListener('click', toggleBookmarksPanel);
        document.getElementById('close-bookmarks')?.addEventListener('click', toggleBookmarksPanel);
        
        // Load first surah by default
        await loadSurah();
        renderBookmarks();
        
        console.log('Quran reader initialized successfully');
    } catch (error) {
        console.error('Error initializing Quran reader:', error);
    }
}

// Add this to the window load event
window.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing Quran reader...');
    loadQuran().catch(error => {
        console.error('Failed to load Quran reader:', error);
    });
});

// Update the loadSurah function to include better error handling
async function loadSurah() {
    console.log('Loading surah...');
    const surahSelect = document.getElementById('surah-select');
    const translationSelect = document.getElementById('translation-select');
    const ayahsContainer = document.getElementById('ayahs-container');
    
    if (!surahSelect || !translationSelect || !ayahsContainer) {
        console.error('Required elements not found');
        return;
    }
    
    const surahNumber = surahSelect.value || '1';
    const translation = translationSelect.value;
    
    ayahsContainer.innerHTML = `
        <div class="text-center p-8">
            <i class="fas fa-spinner fa-spin text-yellow-500 text-3xl"></i>
            <p class="mt-4 text-gray-600">Loading Surah...</p>
        </div>
    `;
    
    try {
        console.log('Fetching surah data:', surahNumber, translation);
        
        const [surahInfo, arabic, translationText] = await Promise.all([
            fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}`).then(r => r.json()),
            fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/ar.alafasy`).then(r => r.json()),
            fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/${translation}`).then(r => r.json())
        ]);
        
        console.log('Surah data fetched successfully');
        
        // Update surah header
        const surahName = document.querySelector('.surah-name');
        const surahTranslation = document.querySelector('.surah-translation');
        
        if (surahName && surahTranslation) {
            surahName.textContent = surahInfo.data.englishName;
            surahTranslation.textContent = surahInfo.data.englishNameTranslation;
        }
        
        // Render ayahs
        let html = '';
        arabic.data.ayahs.forEach((ayah, i) => {
            const ayahId = `${surahNumber}:${ayah.numberInSurah}`;
            const isBookmarked = bookmarks.some(b => b.id === ayahId);
            
            html += `
                <div class="ayah-container" data-ayah-id="${ayahId}">
                    <button class="bookmark-btn ${isBookmarked ? 'bookmarked' : ''}" 
                            data-ayah-id="${ayahId}"
                            onclick="toggleBookmark(this, ${surahNumber}, ${ayah.numberInSurah}, '${surahInfo.data.englishName}')">
                        ${isBookmarked ? '<i class="fas fa-bookmark"></i>' : '<i class="far fa-bookmark"></i>'}
                    </button>
                    <div class="arabic-text">
                        ${ayah.text}
                        <span class="ayah-number">${ayah.numberInSurah}</span>
                    </div>
                    <div class="translation-text">
                        ${translationText.data.ayahs[i].text}
                    </div>
                </div>
            `;
        });
        
        ayahsContainer.innerHTML = html;
        
        // Smooth scroll to top
        const quranReader = document.getElementById('quran-reader');
        if (quranReader) {
            window.scrollTo({
                top: quranReader.offsetTop - 100,
                behavior: 'smooth'
            });
        }
        
        console.log('Surah rendered successfully');
        
    } catch (error) {
        console.error('Error loading surah:', error);
        ayahsContainer.innerHTML = `
            <div class="text-center p-8 text-red-500">
                <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                <p>Failed to load Quran data. Please check your connection and try again.</p>
                <button onclick="loadSurah()" class="mt-4 bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition-all duration-200">
                    <i class="fas fa-redo mr-2"></i>Retry
                </button>
            </div>
        `;
    }
}

function toggleBookmark(button, surahNumber, ayahNumber, surahName) {
    const ayahId = `${surahNumber}:${ayahNumber}`;
    const bookmarkIndex = bookmarks.findIndex(b => b.id === ayahId);
    
    if (bookmarkIndex === -1) {
        // Add bookmark
        bookmarks.push({
            id: ayahId,
            surahNumber,
            ayahNumber,
            surahName,
            timestamp: new Date().toISOString()
        });
        button.classList.add('bookmarked');
        button.innerHTML = '<i class="fas fa-bookmark"></i>';
    } else {
        // Remove bookmark
        bookmarks.splice(bookmarkIndex, 1);
        button.classList.remove('bookmarked');
        button.innerHTML = '<i class="far fa-bookmark"></i>';
    }
    
    // Save to localStorage
    localStorage.setItem('quran-bookmarks', JSON.stringify(bookmarks));
    renderBookmarks();
}

function renderBookmarks() {
    const bookmarksList = document.getElementById('bookmarks-list');
    if (!bookmarksList) return;
    
    if (bookmarks.length === 0) {
        bookmarksList.innerHTML = '<p class="text-gray-500 text-center py-4">No bookmarks yet</p>';
        return;
    }
    
    // Sort by most recent first
    const sortedBookmarks = [...bookmarks].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp));
    
    bookmarksList.innerHTML = sortedBookmarks.map(bookmark => `
        <div class="bookmark-item">
            <span>
                <strong class="text-yellow-800">${bookmark.surahName}</strong>
                <span class="text-gray-600">Ayah ${bookmark.ayahNumber}</span>
            </span>
            <div>
                <button onclick="navigateToAyah(${bookmark.surahNumber}, ${bookmark.ayahNumber})" class="hover:bg-yellow-600 transition-colors">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button onclick="removeBookmark('${bookmark.id}')" class="hover:bg-red-600 transition-colors">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function removeBookmark(ayahId) {
    bookmarks = bookmarks.filter(b => b.id !== ayahId);
    localStorage.setItem('quran-bookmarks', JSON.stringify(bookmarks));
    renderBookmarks();
    
    // Update bookmark buttons in current view
    document.querySelectorAll(`.bookmark-btn[data-ayah-id="${ayahId}"]`).forEach(btn => {
        btn.classList.remove('bookmarked');
        btn.innerHTML = '<i class="far fa-bookmark"></i>';
    });
}

function navigateToAyah(surahNumber, ayahNumber) {
    // Set the surah select
    document.getElementById('surah-select').value = surahNumber;
    
    // Load the surah
    loadSurah().then(() => {
        // Scroll to the specific ayah after a short delay
        setTimeout(() => {
            const ayahElement = document.querySelector(`.ayah-container[data-ayah-id="${surahNumber}:${ayahNumber}"]`);
            if (ayahElement) {
                ayahElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                
                // Highlight the ayah temporarily
                ayahElement.style.backgroundColor = 'rgba(234, 179, 8, 0.1)';
                setTimeout(() => {
                    ayahElement.style.backgroundColor = '';
                }, 2000);
            }
        }, 500);
        
        // Close bookmarks panel
        toggleBookmarksPanel();
    });
}

function toggleBookmarksPanel() {
    const panel = document.getElementById('bookmarks-panel');
    if (panel) {
        panel.classList.toggle('hidden');
    }
}

// Add floating bookmarks button if it doesn't exist
if (!document.getElementById('toggle-bookmarks')) {
    document.body.insertAdjacentHTML('beforeend', `
        <button class="toggle-bookmarks" id="toggle-bookmarks" title="Show Bookmarks">
            <i class="fas fa-bookmark"></i>
        </button>
    `);
}

// ... rest of the existing code ...

// Add this to your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Handle bottom navigation active states
    const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
    const sections = document.querySelectorAll('section');

    // Update active state on scroll
    window.addEventListener('scroll', function() {
        let current = '';
        
        sections.forEach(section => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            if (pageYOffset >= (sectionTop - 200)) {
                current = section.getAttribute('id');
            }
        });

        bottomNavItems.forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('href').slice(1) === current) {
                item.classList.add('active');
            }
        });
    });

    // Smooth scroll for navigation items
    bottomNavItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').slice(1);
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// ... rest of your existing JavaScript code ...

// Add this JavaScript right after your existing DOMContentLoaded event listener

// Function to show only selected section and hide others
function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show selected section
    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) {
        selectedSection.style.display = 'block';
    }
    
    // Update active state in navigation
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('href') === '#' + sectionId) {
            item.classList.add('active');
        }
    });
}

// Initialize with first section
document.addEventListener('DOMContentLoaded', function() {
    // Show prayer-times section by default
    showSection('prayer-times');
    
    // Add click handlers to navigation items
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').slice(1);
            showSection(targetId);
        });
    });
});

// Update the sections to have proper initial state
document.querySelectorAll('section').forEach(section => {
    section.style.display = 'none';
});

// Remove the scroll event listener since we're not using it anymore
window.removeEventListener('scroll', () => {});

// Update styles for sections
const sectionStyles = `
    section {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    section[style*="display: block"] {
        opacity: 1;
        transform: translateY(0);
    }
`;

// Add the styles to the document
const styleSheet = document.createElement("style");
styleSheet.textContent = sectionStyles;
document.head.appendChild(styleSheet);

// Update bottom navigation styles
const navStyles = `
    .bottom-nav-item {
        opacity: 0.7;
        transform: scale(0.95);
        transition: all 0.2s ease;
    }
    
    .bottom-nav-item.active {
        opacity: 1;
        transform: scale(1);
        color: #eab308;
        background-color: #fef3c7;
    }
`;

// Add the nav styles to the document
const navStyleSheet = document.createElement("style");
navStyleSheet.textContent = navStyles;
document.head.appendChild(navStyleSheet);

// Add loading indicator functionality
function showLoading() {
    document.getElementById('loading-indicator').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading-indicator').style.display = 'none';
}

// Update showSection function to include loading state
async function showSection(sectionId) {
    showLoading();
    
    // Hide all sections
    document.querySelectorAll('section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show selected section
    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) {
        selectedSection.style.display = 'block';
        
        // Refresh any dynamic content in the section
        if (sectionId === 'calendar-view' && window.mainCalendar) {
            window.mainCalendar.render();
        }
        
        // Update prayer times if showing prayer-times section
        if (sectionId === 'prayer-times') {
            await getPrayerTimesByCity(state.location.city);
        }
    }
    
    // Update active state in navigation
    document.querySelectorAll('.bottom-nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('href') === '#' + sectionId) {
            item.classList.add('active');
        }
    });
    
    hideLoading();
}

// Add this to your existing JavaScript
function updatePrayerTimes(times) {
    if (!times) return;
    
    // Update prayer list times
    document.getElementById('fajr-time').textContent = times.Fajr;
    document.getElementById('dhuhr-time').textContent = times.Dhuhr;
    document.getElementById('asr-time').textContent = times.Asr;
    document.getElementById('maghrib-time').textContent = times.Maghrib;
    document.getElementById('isha-time').textContent = times.Isha;
    
    // Update sunrise and sunset times
    document.getElementById('sunrise-time').textContent = times.Sunrise;
    document.getElementById('sunset-time').textContent = times.Sunset;
    
    // Update current date
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('current-date').textContent = today.toLocaleDateString('de-DE', options);
    
    // Update location
    document.getElementById('current-location').textContent = state.location.city;
    
    // Calculate and update next prayer
    updateNextPrayer(times);
}

function updateNextPrayer(times) {
    const now = new Date();
    const currentTime = now.getHours() * 60 + now.getMinutes();
    
    const prayerTimes = [
        { name: 'Fajr', time: timeToMinutes(times.Fajr) },
        { name: 'Dhuhr', time: timeToMinutes(times.Dhuhr) },
        { name: 'Asr', time: timeToMinutes(times.Asr) },
        { name: 'Maghrib', time: timeToMinutes(times.Maghrib) },
        { name: 'Isha', time: timeToMinutes(times.Isha) }
    ];
    
    let nextPrayer = prayerTimes.find(prayer => prayer.time > currentTime);
    if (!nextPrayer) {
        nextPrayer = prayerTimes[0]; // Next day's Fajr
    }
    
    const timeToNext = nextPrayer.time - currentTime;
    const hours = Math.floor(timeToNext / 60);
    const minutes = timeToNext % 60;
    
    document.getElementById('next-prayer-time').textContent = formatTime(nextPrayer.time);
    document.getElementById('time-remaining').textContent = 
        `${hours > 0 ? hours + ' hours and ' : ''}${minutes} minutes to go`;
}

function timeToMinutes(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
}

function formatTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
}

// Update times every minute
setInterval(() => {
    const times = state.prayerTimes[new Date().toISOString().split('T')[0]];
    if (times) {
        updateNextPrayer(times);
    }
}, 60000);

// Prayer times functionality
let currentLocation = {
    city: localStorage.getItem('prayerCity') || '',
    country: localStorage.getItem('prayerCountry') || '',
    latitude: localStorage.getItem('prayerLatitude') || null,
    longitude: localStorage.getItem('prayerLongitude') || null
};

let prayerTimes = {};
let prayerUpdateInterval;

// DOM Elements
let prayerElements = {
    locationDisplay: null,
    prayerList: null,
    prayerTimeLarge: null,
    timeRemaining: null,
    sunriseTime: null,
    sunsetTime: null
};

// Initialize DOM elements
function initializeDOMElements() {
    prayerElements = {
        locationDisplay: document.querySelector('.location-display'),
        prayerList: document.querySelector('.prayer-list'),
        prayerTimeLarge: document.querySelector('.prayer-time-large'),
        timeRemaining: document.querySelector('.time-remaining'),
        sunriseTime: document.querySelector('.sunrise-time'),
        sunsetTime: document.querySelector('.sunset-time')
    };

    // Create elements if they don't exist
    if (!prayerElements.prayerList) {
        const prayerWidget = document.createElement('div');
        prayerWidget.innerHTML = `
            <div class="prayer-widget">
                <div class="location-display"></div>
                <div class="prayer-time-large">--:--</div>
                <div class="time-remaining"></div>
                <div class="prayer-list"></div>
                <div class="sun-times">
                    <span class="sunrise-time"></span>
                    <span class="sunset-time"></span>
                </div>
            </div>
        `;
        document.body.appendChild(prayerWidget);
        
        // Re-query elements
        initializeDOMElements();
    }
}

async function initializePrayerTimes() {
    try {
        console.log('Initializing prayer times...');
        
        // Initialize DOM elements first
        initializeDOMElements();
        
        // Try to load saved location
        if (currentLocation.city && prayerElements.locationDisplay) {
            console.log('Found saved location:', currentLocation);
            prayerElements.locationDisplay.textContent = currentLocation.city;
            await fetchPrayerTimes();
        } else {
            console.log('No saved location found, attempting to detect...');
            await detectLocation();
        }
        
        setupPrayerTimesListeners();
        startPrayerTimeUpdates();
    } catch (error) {
        console.error('Error in initializePrayerTimes:', error);
        showError('Fehler beim Initialisieren der Gebetszeiten');
    }
}

function showError(message) {
    if (prayerElements.prayerList) {
        prayerElements.prayerList.innerHTML = `<div class="text-red-500 p-4">${message}</div>`;
    }
    if (prayerElements.prayerTimeLarge) {
        prayerElements.prayerTimeLarge.textContent = '--:--';
    }
    if (prayerElements.timeRemaining) {
        prayerElements.timeRemaining.textContent = '';
    }
}

async function fetchPrayerTimes() {
    try {
        const today = new Date();
        const date = today.toISOString().split('T')[0];
        
        // Check if we have cached prayer times for today
        const cachedTimes = localStorage.getItem(`prayerTimes_${date}`);
        if (cachedTimes) {
            console.log('Using cached prayer times for:', date);
            prayerTimes = JSON.parse(cachedTimes);
            updatePrayerTimesDisplay();
            return;
        }

        if (!currentLocation.latitude || !currentLocation.longitude) {
            throw new Error('Standortdaten fehlen. Bitte geben Sie einen Standort ein.');
        }

        const apiUrl = `https://api.aladhan.com/v1/timings/${date}?latitude=${currentLocation.latitude}&longitude=${currentLocation.longitude}&method=2`;
        console.log('Fetching from URL:', apiUrl);

        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();

        if (data.code === 200 && data.data && data.data.timings) {
            prayerTimes = data.data.timings;
            localStorage.setItem(`prayerTimes_${date}`, JSON.stringify(prayerTimes));
            updatePrayerTimesDisplay();
        } else {
            throw new Error('Ungültige Antwort vom Server');
        }
    } catch (error) {
        console.error('Error in fetchPrayerTimes:', error);
        showError(`Fehler beim Abrufen der Gebetszeiten: ${error.message}`);
    }
}

function updatePrayerTimesDisplay() {
    if (!prayerElements.prayerList) return;

    const prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
    const germanNames = {
        'Fajr': 'Fadschr',
        'Sunrise': 'Sonnenaufgang',
        'Dhuhr': 'Dhuhr',
        'Asr': 'Asr',
        'Maghrib': 'Maghrib',
        'Isha': 'Ischa'
    };

    prayerElements.prayerList.innerHTML = '';
    
    prayers.forEach(prayer => {
        if (!prayerTimes[prayer]) return;

        const time = prayerTimes[prayer];
        const now = new Date();
        const [hours, minutes] = time.split(':');
        const prayerTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
        
        const isPassed = now > prayerTime;
        const isNext = !isPassed && now < prayerTime && 
                      !prayers.slice(0, prayers.indexOf(prayer)).some(p => {
                          const [h, m] = prayerTimes[p].split(':');
                          const pt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
                          return now < pt;
                      });

        const item = document.createElement('div');
        item.className = `prayer-list-item${isPassed ? ' passed' : ''}${isNext ? ' active' : ''}`;
        item.innerHTML = `
            <span class="prayer-name">${germanNames[prayer]}</span>
            <span class="prayer-time">
                ${time}
                ${isNext ? '<i class="fas fa-clock"></i>' : ''}
            </span>
        `;
        prayerElements.prayerList.appendChild(item);

        if (isNext && prayerElements.prayerTimeLarge && prayerElements.timeRemaining) {
            prayerElements.prayerTimeLarge.textContent = time;
            prayerElements.timeRemaining.textContent = getTimeRemaining(prayerTime);
        }
    });

    if (prayerElements.sunriseTime && prayerTimes['Sunrise']) {
        prayerElements.sunriseTime.textContent = prayerTimes['Sunrise'];
    }
    if (prayerElements.sunsetTime && prayerTimes['Sunset']) {
        prayerElements.sunsetTime.textContent = prayerTimes['Sunset'];
    }
}

function getTimeRemaining(prayerTime) {
    const now = new Date();
    const diff = prayerTime - now;
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    return `${hours}h ${minutes}m verbleibend`;
}

function startPrayerTimeUpdates() {
    if (prayerUpdateInterval) {
        clearInterval(prayerUpdateInterval);
    }

    prayerUpdateInterval = setInterval(() => {
        if (Object.keys(prayerTimes).length > 0) {
            updatePrayerTimesDisplay();
        }
    }, 60000);

    if (Object.keys(prayerTimes).length > 0) {
        updatePrayerTimesDisplay();
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initializePrayerTimes);

function setupPrayerTimesListeners() {
    const locationForm = document.getElementById('location-form');
    const detectLocationBtn = document.getElementById('detect-location');

    if (locationForm) {
        locationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cityInput = document.getElementById('city-input');
            if (cityInput) {
                await setLocation(cityInput.value);
            }
        });
    }

    if (detectLocationBtn) {
        detectLocationBtn.addEventListener('click', detectLocation);
    }
}

async function setLocation(city) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
        const data = await response.json();
        
        if (data.length === 0) {
            throw new Error('Stadt nicht gefunden. Bitte versuchen Sie es erneut.');
        }

        const location = data[0];
        currentLocation = {
            city: location.display_name.split(',')[0],
            country: location.display_name.split(',').slice(-1)[0].trim(),
            latitude: location.lat,
            longitude: location.lon
        };

        saveLocation();
        if (prayerElements.locationDisplay) {
            prayerElements.locationDisplay.textContent = currentLocation.city;
        }
        await fetchPrayerTimes();
    } catch (error) {
        console.error('Error setting location:', error);
        showError(error.message);
    }
}

async function detectLocation() {
    if (!navigator.geolocation) {
        showError('Geolocation wird von Ihrem Browser nicht unterstützt.');
        return;
    }

    try {
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
        });

        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}`
        );
        const data = await response.json();

        currentLocation = {
            city: data.address.city || data.address.town || data.address.village,
            country: data.address.country,
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
        };

        saveLocation();
        if (prayerElements.locationDisplay) {
            prayerElements.locationDisplay.textContent = currentLocation.city;
        }
        await fetchPrayerTimes();
    } catch (error) {
        console.error('Error detecting location:', error);
        showError('Fehler beim Erkennen des Standorts. Bitte versuchen Sie es manuell.');
    }
}

function saveLocation() {
    localStorage.setItem('prayerCity', currentLocation.city);
    localStorage.setItem('prayerCountry', currentLocation.country);
    localStorage.setItem('prayerLatitude', currentLocation.latitude);
    localStorage.setItem('prayerLongitude', currentLocation.longitude);
}
</script>
</body>
</html> 